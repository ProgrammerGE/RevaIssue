<app-nav-bar></app-nav-bar>

<div class="parent">
  <!-- title -->
  <div class="div1">
    <!-- This will contain an element that reflects the name of the project entity -->
    <h3>{{ projectTitle() }}</h3>
  </div>
  <!-- description -->
  <div class="div2">
    <!-- This will contain an element that says something like "Description:". This could be removed -->
    <!-- <h4>Description:</h4> -->
    <p>{{ projectDescription() }}</p>
  </div>
  <!-- users display -->
  <div class="div3">
    <h2>Users List</h2>
    <!-- Show button/form for adding and removing users -->
    @if (userRole() === 'admin') {
    <button (click)="addUserToProject()">Add User</button>
    <input
      type="text"
      [ngModel]="newUser()"
      (ngModelChange)="newUser.set($event)"
      placeholder="Enter username"
    />
    }
    <!-- Show the user list -->
    <div id="project-user-list">
      @for (user of users(); track user.username; let i = $index) {
      <div
        class="user-item"
        [class.is-admin]="userRole() === 'admin'"
        (click)="userRole() === 'admin' ? onUserClick(user) : null"
      >
        <strong>{{ user.username }} {{ user.role }}</strong>
      </div>
      } @empty {
      <p>No users found or still loading...</p>
      }
    </div>
  </div>
  <!-- issue selector pane -->
  <div class="div4">
    <!--First is the issues browser pane. It shows the projects issues. Users can click on them
              to be taken to a page where they can view that issue's details. Testers have a button
              to create issues. -->
    <div class="issues-header">
      <h4>Project Issues</h4>
      @if (userRole() === 'tester') {
      <app-create-issue></app-create-issue>
      <button class="btn-create" (click)="addPopup()">Create Issue</button>
      }
      <div class="filter_status">
        <select name="status" [(ngModel)]="statusInput">
          <option value="Open">OPEN</option>
          <option value="In Progress">IN PROGRESS</option>
          <option value="Resolved">RESOLVED</option> 
          <option value="Close">CLOSED</option>       
        </select> 
    </div>   
      <select name="filter_priority" [(ngModel)]="priorityInput">
        <option value="1">Low</option>
        <option value="2">Medium</option>
        <option value="3">High</option>
      </select>
    </div>
    <div>
      <select name="filter_severity" [(ngModel)]="severityInput">
        <option value="1">Low</option>
        <option value="2">Medium</option>
        <option value="3">High</option>
      </select>
    </div>
    <div>
      <button class="btn-filter" (click)="filterIssues()">Filter Issues</button>
      <button class="btn-filter_rest" (click)="resetFilter()">Reset Filter</button>
    </div>

    <div class="issues-list">
      @for (issue of issues(); track issue.issueID) {
      <div
        class="issue-card"
        (mouseenter)="hoveredIssue = issue"
        (mouseleave)="hoveredIssue = null"
        (click)="selectIssue(issue)"
        [class.active]="selectedIssue?.issueID === issue.issueID"
      >
        <span class="issue-id">#{{ issue.issueID }} </span>
        <span class="issue-title">{{ issue.name }}</span>
        <span class="issue-priority" [attr.data-priority]="issue.priority">
          {{ issue.priority }}
        </span>
        <span class="button_update">
          <app-update-issue [issueTitle]="issue.name"
                            [issueDesc]="issue.description"
                            [severityInput]="issue.severity.toString()"
                            [priorityInput]="issue.priority.toString()"
                            [issueID]="issue.issueID"></app-update-issue>
      </span>
      </div>
      }
    </div>
  </div>
  <!-- issue viewing pane -->
  <div class="div5">
    <div class="view-pane-container">
      @if (hoveredIssue || selectedIssue) { @let current = (hoveredIssue || selectedIssue)!;

      <div class="issue-details fade-in">
        <div class="details-header">
          <h3>{{ current.name }}</h3>
          <span class="status-badge" [attr.data-status]="current.status">{{ current.status }}</span>
        </div>

        <div class="metrics-row">
          <span class="metric"><strong>Priority:</strong> {{ current.priority }}</span>
          <span class="metric"><strong>Severity:</strong> {{ current.severity }}</span>
        </div>

        <div class="description-section">
          <h4>Description</h4>
          <p>{{ current.description }}</p>
        </div>
      </div>

      <hr />

      <div class="comments-section">
        <div>
          @if (userRole() === 'tester') {
          <button (click)="reopenIssue()">Re-open issue</button>
          <button (click)="closeIssue()">Close issue</button>
          } @else if (userRole() === 'developer') {
          <button (click)="startProgress()">Move to in progress</button>
          <button (click)="resolveIssue()">Resolve Issue</button>
          }
        </div>
        <h4>Comments ({{ current?.comments?.length || 0 }})</h4>
        <div class="comment-input-placeholder">
          <input type="text" placeholder="Add a comment..." disabled />
          <button disabled>Send</button>
        </div>

        <div class="comments-scroll-area">
          @for (comment of current?.comments?.slice()?.reverse(); track $index) {
          <div class="comment-item">
            <div class="comment-meta">
              <span class="author">{{ comment.author }}</span>
              <span class="date">{{ comment.dateCreated }}</span>
            </div>
            <p class="comment-text">{{ comment.text }}</p>
          </div>
          } @empty {
          <p class="no-comments">No comments yet.</p>
          }
        </div>
      </div>

      } @else {
      <div class="empty-state">
        <p>Select an issue to view full details and comments</p>
      </div>
      }
    </div>
  </div>
</div>
